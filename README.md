# 会议对讲模块组件自动化安装<br>
<br>

<br>

## 1. 环境准备 (Prerequisites)<br>
<br>
在运行脚本之前，请确保电脑满足以下条件：<br>
<br>

### 1.1 软件环境<br>
* **操作系统**: Windows 10/11<br>
* **Python**: Python 3.6 或更高版本<br>
* **依赖库**: 请在终端（CMD 或 PowerShell）执行以下命令安装所需库：<br>
    `pip install paramiko scp pyserial`<br>
<br>

### 1.2 硬件连接<br>
1.  **网络连接**: 使用网线将电脑连接至设备。<br>
    * 电脑 IP 需设置为 `192.168.1.x` 网段。<br>
    * 确保能 Ping 通设备默认 IP `192.168.1.2`。<br>
2.  **串口连接**: 使用 USB转TTL 串口线连接设备的调试口，并插入电脑 USB 接口。<br>
<br>
---<br>
<br>

## 2. 目录结构要求<br>
<br>
脚本采用相对路径查找资源文件，**请务必保持以下目录结构**，否则脚本将报错“找不到文件”。<br>
<br>
项目根目录/<br>
│<br>
├── ss528v100增加USB音频/              <-- 音频补丁文件夹 <br>
│   ├── fip.bin.sh<br>
│   ├── alsa-lib_utils.tar.gz<br>
│   └── ... (其他补丁文件)<br>
│<br>
├── install_dt-V1.0.0-ss528v100-Linux.tar.gz   <-- 应用安装包<br>
│                                                <br>
│<br>
└── scripts/                             <-- 脚本存放目录<br>
    └── auto_deploy.py                   <-- 本脚本文件<br>
<br>

<br>
## 3. 配置参数 (Configuration)<br>
<br>
在使用前，请打开 `auto_deploy.py` 文件顶部，根据实际情况修改配置区域：<br>
<br>

```python
# ================= 基础配置 =================<br>
DEVICE_IP = '192.168.1.2'      # 设备 IP 地址<br>
SSH_PORT = 22                  # SSH 端口<br>
USERNAME = 'root'              # SSH 登录用户名<br>
PASSWORD = 'root'              # SSH 登录密码<br>
<br>
# ================= 串口配置 =================<br>
SERIAL_PORT = 'COM9'           # [重要] 修改为您电脑实际识别到的串口号 (如 COM3)<br>
BAUDRATE = 115200              # 波特率<br>
```

<br>
<br>
> 右键点击“此电脑” -> “管理” -> “设备管理器” -> “端口 (COM 和 LPT)”，查看 USB-SERIAL 对应的 COM 号。<br>
<br>

<br>
## 4. 运行步骤 (Run Guide)<br>
<br>
在 `scripts` 目录下打开终端，运行脚本：<br>
<br>
`python auto_deploy.py`<br>
<br>

### 执行流程详解<br>
<br>
脚本将按以下顺序自动执行：<br>
<br>

#### 第一阶段：SSH 自动化部署<br>
1.  **等待上线**: 脚本自动 Ping 设备，接通后建立 SSH 连接。<br>
2.  **[1/4] USB 音频补丁**:<br>
    * 自动上传补丁文件到 `/dev/shm`。<br>
    * 执行安装脚本并更新系统配置。<br>
    * **自动重启**: 设备会自动重启以应用内核更改。<br>
3.  **断线重连**: 脚本会自动等待设备重启完成并重新建立 SSH 连接。<br>
4.  **[2/4] 安装应用**:<br>
    * 自动寻找上一级目录中**最新**的 `.tar.gz` 安装包。<br>
    * 上传、解压并运行 `install.sh`。<br>
5.  **[3/4] 设置开机画面**:<br>
    * 替换 Bootlogo 并写入 Flash。<br>
<br>

#### 第二阶段：串口 U-Boot 配置<br>
6.  **[4/4] U-Boot 参数配置**:<br>
    * 脚本会提示：`修改设备信息后，按回车继续...`<br>
    * 此时脚本会通过 SSH 发送重启命令。<br>
    * **操作**: 请按 **回车键** 确认，脚本将尝试连接串口。<br>
7.  **进入 U-Boot**:<br>
    * 脚本会在串口中连发回车，或检测 `stop autoboot` 信号。<br>
    * 一旦进入 `#`命令行，脚本将自动下发环境变量配置。<br>
8.  **完成**:<br>
    * 显示 `U-Boot 参数修改完成`，设备将再次重启进入系统。<br>
<br>

<br>
## 5. 常见问题排查 (Troubleshooting)<br>
<br>

| 问题现象 | 可能原因 | 解决方法 |
| :--- | :--- | :--- |
| **找不到应用安装包** | 目录结构错误 | 确认 `.tar.gz` 文件是否在脚本的**上一级目录**，且文件名包含 `install_dt-` 和 `-ss528v100-Linux`。 |
| **SSH 连接失败** | 网络不通或密码错误 | 1. 检查网线连接；<br>2. 检查本机 IP 设置；<br>3. 确认脚本中 `DEVICE_IP`、`USERNAME` 与板子一致。 |
| **U-Boot 拦截失败** | 串口被占用 | **务必关闭**所有其他串口调试助手软件，然后重新运行脚本。 |
| **拦截超时** | 启动太快或串口号选错 | 确认运行脚本时选择了正确的 COM 口；确认串口线连接稳固。 |


<br>

## 6. 注意事项<br>
<br>

 **唯一性**: 脚本逻辑中 `find_app_package` 会自动选择修改时间**最新**的一个安装包，请清理目录下过期的旧包，以免刷错版本。<br>

 **断电风险**: 在刷写 Flash (Bootlogo) 或修改 U-Boot 参数时，请勿断开电源，否则可能导致设备变砖。<br>
