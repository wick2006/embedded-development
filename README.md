# embedded-development

# 1、全自动部署脚本使用说明 (Auto-Deploy Guide)

本脚本依据《会议对讲模块组件生产安装指导V00.02》编写，用于会议对讲模块组件的自动化生产部署。脚本整合了 **SSH** (文件传输/系统配置) 与 **串口** (U-Boot参数设置) 两种通信方式，实现一键化生产。

---

## 1. 环境准备 (PC端)

在运行脚本之前，请确保电脑已安装 Python 3 环境。
请打开命令行终端 (CMD 或 PowerShell)，运行以下命令安装必要的依赖库：

pip install paramiko scp pyserial

---

## 2. 目录结构要求 (⚠️ 关键)

脚本设计为自动搜索“上一级目录”的资源文件，以适应不同版本的安装包。
请务必严格按照以下目录结构存放文件（已按要求添加 <br> 换行符以便于格式保持）：

您的项目根目录/<br>
│<br>
├── ss528v100增加USB音频/             <-- [必须] 补丁文件夹 (名称需完全一致)<br>
│   ├── fip.bin.sh<br>
│   ├── alsa-lib_utils.tar.gz<br>
│   └── ... (文件夹内的其他原文件)<br>
│<br>
├── install_dt-V1.0.0.0-ss528v100-Linux.tar.gz  <-- [必须] 应用安装包<br>
│                                               (脚本会自动识别版本号，只需文件名格式匹配即可)<br>
│<br>
└── scripts/                            <-- [建议] 脚本存放目录<br>
    └── auto_deploy.py                  <-- 本脚本文件放在这里<br>

---

## 3. 硬件连接与配置

在运行脚本前，请完成以下硬件连接：

1.  **网络连接 (SSH通道)**：
    * [cite_start]使用网线连接电脑与设备的网口 [cite: 4]。
    * 请将电脑的有线网卡 IP 设置为 `192.168.1.x` 网段 (例如 192.168.1.100)。
    * [cite_start]确保电脑能 Ping 通设备的默认 IP：`192.168.1.2` [cite: 4]。

2.  **串口连接 (U-Boot通道)**：
    * [cite_start]使用 USB转TTL 串口线连接设备的调试串口 (UART) [cite: 4]。
    * 连接电脑 USB 口，并确认设备管理器中已生成 COM 口 (如 COM3)。
    * **重要警示：请务必关闭 SecureCRT、XShell、PuTTY 等占用串口的终端软件，否则脚本无法打开串口拦截 U-Boot！**

---

## 4. 运行脚本

在 `scripts` 目录下打开命令行终端，运行：

python auto_deploy.py

### 脚本执行流程详解

1.  **选择串口 (交互步骤)**：
    脚本启动后会扫描并列出当前电脑的所有串口。
    示例输出：
      [0] COM3 - USB-SERIAL CH340
    👉 请输入对应的数字序号 (如 0) 并回车。如果只有一个串口，直接按回车即可。

2.  **等待设备上线 (自动步骤)**：
    屏幕显示 `等待设备上线 (Ping)...`。
    * 如果设备未通电，请此时给设备上电。
    * 一旦 Ping 通，脚本将自动建立 SSH 连接。

3.  **自动化部署阶段 (自动步骤)**：
    * [cite_start]**[1/3] 安装 USB 音频补丁**：自动上传 `ss528v100增加USB音频` 下的所有文件到 `/dev/shm`，并执行 `fip.bin.sh` 及文件拷贝命令 [cite: 5]。
    * [cite_start]**[2/3] 安装应用**：自动寻找上一级目录中最新的 `.tar.gz` 包，上传解压并运行 `install.sh` [cite: 5]。
    * [cite_start]**[3/3] 设置开机画面**：执行 Linux 侧的 `bootlogo` 写入命令 [cite: 7]。

4.  **重启与 U-Boot 拦截 (自动步骤)**：
    * [cite_start]脚本通过 SSH 发送 `reboot` 命令重启设备 [cite: 7]。
    * 脚本立即切换到串口模式，持续发送回车键以拦截启动过程。
    * [cite_start]进入 `hisilicon #` 命令行后，自动下发环境变量 (`bootcmd`)，保存并复位 [cite: 7]。
    * 看到 `✅ U-Boot 参数修改完成` 提示后，流程结束。

---

## 5. 常见问题排查 (Troubleshooting)

| 问题现象 | 可能原因 | 解决方法 |
| :--- | :--- | :--- |
| **找不到应用安装包** | 目录结构错误 | 确认 `.tar.gz` 文件是否在脚本的**上一级目录**，且文件名包含 `install_dt-` 和 `-ss528v100-Linux`。 |
| **SSH 连接失败** | 网络不通或密码错误 | 1. 检查网线连接；<br>2. 检查本机 IP 设置；<br>3. 确认脚本中 `DEVICE_IP`、`USERNAME` 与板子一致。 |
| **U-Boot 拦截失败** | 串口被占用 | **务必关闭**所有其他串口调试助手软件，然后重新运行脚本。 |
| **拦截超时** | 启动太快或串口号选错 | 确认运行脚本时选择了正确的 COM 口；确认串口线连接稳固。 |

---

## 6. 参数修改

如果需要修改默认 IP、账号密码或串口波特率，请直接编辑 `auto_deploy.py` 文件顶部的配置区域：

# ================= 基础配置 =================
DEVICE_IP = '192.168.1.2'   # 设备默认IP
SSH_PORT = 22
USERNAME = 'root'           # 登录用户名
PASSWORD = 'root'           # 登录密码
...
BAUDRATE = 115200           # 串口波特率
